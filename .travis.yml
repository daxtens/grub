# SPDX-License-Identifier: GPL-3.0+
# Originally Copyright Roger Meier <r.meier@siemens.com>
# Adapted for GRUB by Alexander Graf <agraf@suse.de>
#
# Build GRUB on Travis CI - https://www.travis-ci.org/
#

dist: bionic

language: c

addons:
  apt:
    packages:
    - libsdl1.2-dev
    - lzop
    - ovmf
    - python
    - qemu-system
    - unifont
    - autopoint
    - gcc-powerpc-linux-gnu
    - gcc-mips-linux-gnu
    - gcc-mipsel-linux-gnu
    - gcc-riscv64-linux-gnu
    - gcc-sparc64-linux-gnu
    - gcc-arm-linux-gnueabi
    - gcc-aarch64-linux-gnu
    - xorriso
    - openbios-ppc
    - openbios-sparc

script:
  # Comments must be outside the command strings below, or the Travis parser
  # will get confused.
  - ./bootstrap

  # Build all selected GRUB targets.
  - for target in $GRUB_TARGETS; do
      plat=${target#*-};
      arch=${target%-*};
      [ "$arch" = "arm64" ] && arch=aarch64-linux-gnu;
      [ "$arch" = "arm" ] && arch=arm-linux-gnueabi;
      [ "$arch" = "mipsel" ] && arch=mipsel-linux-gnu;
      [ "$arch" = "mips" ] && arch=mips-linux-gnu;
      [ "$arch" = "powerpc" ] && arch=powerpc-linux-gnu;
      [ "$arch" = "riscv64" ] && arch=riscv64-linux-gnu;
      [ "$arch" = "sparc64" ] && arch=sparc64-linux-gnu;
      echo "Building $target";
      mkdir obj-$target;
      JOBS=`getconf _NPROCESSORS_ONLN 2> /dev/null || echo 1`;
      [ "$JOBS" == 1 ] || JOBS=$(($JOBS + 1));
      ( cd obj-$target &&
        ../configure --target=$arch --with-platform=$plat --prefix=/tmp/grub &&
        make -j$JOBS && make -j$JOBS install ) &> log || ( cat log; false );
      if [ "$CHECK" = "yes" ]; then ( cd obj-$target && make test_asn1 && ./test_asn1 ); fi
    done

matrix:
  include:
  # Each env setting here is a dedicated build.
    - name: "emu"
      env:
        - GRUB_TARGETS="x86_64-emu"
        - CHECK=yes
    - name: "x86_64"
      env:
        - GRUB_TARGETS="x86_64-efi x86_64-xen"
    - name: "i386"
      env:
        - GRUB_TARGETS="i386-coreboot i386-efi i386-ieee1275 i386-multiboot i386-pc i386-qemu i386-xen i386-xen_pvh"
    - name: "powerpc"
      env:
        - GRUB_TARGETS="powerpc-ieee1275"
        - CHECK=yes
    - name: "sparc64"
      env:
        - GRUB_TARGETS="sparc64-ieee1275"
        - CHECK=yes
    - name: "mips"
      env:
        - GRUB_TARGETS="mips-arc mips-qemu_mips"
    - name: "mipsel"
      env:
        - GRUB_TARGETS="mipsel-arc mipsel-qemu_mips"
    - name: "arm"
      env:
        - GRUB_TARGETS="arm-coreboot arm-efi arm-uboot"
    - name: "arm64"
      env:
        - GRUB_TARGETS="arm64-efi"
    - name: "riscv64"
      env:
        - GRUB_TARGETS="riscv64-efi"
